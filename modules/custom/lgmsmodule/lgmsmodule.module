<?php
use Drupal\Core\Entity\Display\EntityFormDisplayInterface;

use Drupal\lgmsmodule\Controller\landingPageHelper;
use Drupal\Component\Plugin\Exception\InvalidPluginDefinitionException;
use Drupal\Component\Plugin\Exception\PluginNotFoundException;
use Drupal\Component\Serialization\Json;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Entity\Entity\EntityFormDisplay;
use Drupal\Core\Entity\Entity\EntityViewDisplay;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\EntityStorageException;
use Drupal\Core\Link;
use Drupal\Core\Url;
use Drupal\field\Entity\FieldConfig;
use Drupal\field\Entity\FieldStorageConfig;
use Drupal\node\Entity\Node;
use Drupal\node\Entity\NodeType;
use Drupal\node\NodeInterface;
use Drupal\taxonomy\Entity\Vocabulary;
use Drupal\taxonomy\Entity\Term;
use Drupal\Core\Field\FieldStorageDefinitionInterface;

/**
 * Implements hook_theme().
 */
function lgmsmodule_theme($existing, $type, $theme, $path) {
  return [
    'lgmsmodule_content' => [
      'variables' => ['table' => NULL],
      'template' => 'lgmsmodule-content',
    ],
  ];
}

/**
 * This is executed when a node is created or updated.
 * This is used to generate URL aliases for guide and page nodes.
 * @param \Drupal\node\NodeInterface $node
 *   The node that is being inserted or updated.
 */
function lgmsmodule_generate_url_alias(NodeInterface $node) {
  // Alias generation for 'guide' content type remains the same.
  if ($node->getType() == 'guide') {
    $alias = '/' . strtolower(preg_replace('/[^a-z0-9]+/i', '-', $node->getTitle()));
  }
  // Alias generation for 'page' content type needs to reflect the parent-child relationship.
  elseif ($node->getType() == 'guide_page') {
    // Load the parent guide node.
    $parent_guide = $node->get('field_parent_guide')->entity;
    if ($parent_guide) {
      // Construct the alias using the parent guide's title and the page's title.
      $parent_alias = strtolower(preg_replace('/[^a-z0-9]+/i', '-', $parent_guide->getTitle()));
      $child_alias = strtolower(preg_replace('/[^a-z0-9]+/i', '-', $node->getTitle()));
      $alias = '/' . $parent_alias . '/' . $child_alias;
    } else {
      // If there's no parent guide, fallback to just using the page title.
      $alias = '/' . strtolower(preg_replace('/[^a-z0-9]+/i', '-', $node->getTitle()));
    }
  } elseif ($node->getType() == 'sub_page') {
    $parent_page = $node->get('field_parent_page')->entity;

    if ($parent_page) {
      // Construct the alias using the parent guide's title and the page's title.
      $parent_alias = strtolower(preg_replace('/[^a-z0-9]+/i', '-', $parent_page->getTitle()));
      $parent_guide = $parent_page->get('field_parent_guide')->entity;
      if($parent_guide){
        $parent_guide_alias = strtolower(preg_replace('/[^a-z0-9]+/i', '-', $parent_guide->getTitle()));
        $child_alias = strtolower(preg_replace('/[^a-z0-9]+/i', '-', $node->getTitle()));
        $alias = '/' . $parent_guide_alias . '/' . $parent_alias . '/' . $child_alias;
      }
    } else {
      // If there's no parent guide, fallback to just using the page title.
      $alias = '/' . strtolower(preg_replace('/[^a-z0-9]+/i', '-', $node->getTitle()));
    }
  } else {
    // If the content type is neither 'guide' nor 'page', do nothing.
    return;
  }

  // Trim leading or trailing hyphens from the alias.
  $alias = trim($alias, '-');

  // Check if the alias already exists.
  $path_alias_repository = \Drupal::service('path_alias.repository');
  $existing_alias = $path_alias_repository->lookupByAlias($alias, $node->language()->getId());

  // If the alias does not exist or it's not the current node's alias, create or update it.
  if (!$existing_alias || $existing_alias['path'] !== '/node/' . $node->id()) {
    // Create a new alias or update the existing one.
    $path_alias_storage = \Drupal::entityTypeManager()->getStorage('path_alias');
    $path_alias = $path_alias_storage->create([
      'path' => '/node/' . $node->id(),
      'alias' => $alias,
      'langcode' => $node->language()->getId(),
    ]);
    $path_alias->save();
  }
}

/**
 * Implements hook_block_access().
 */
function lgmsmodule_block_access(\Drupal\block\BlockInterface $block, $operation, \Drupal\Core\Session\AccountInterface $account) {
  // Get the current route.
  $current_route = \Drupal::routeMatch()->getRouteName();
  $node = \Drupal::routeMatch()->getParameter('node');
  $routes = [
    'entity.node.edit_form',
    'entity.node.delete_form',
    'entity.node.version_history',
    'entity.node.devel_load',
    'entity.node.devel_load_with_references',
    'entity.node.devel_render',
    'entity.node.devel_definition',
  ];


  // Check if the current route is for a node edit form.
  if ($node && $node->getType() == 'guide' && in_array($current_route, $routes) && $block->id() === 'lgmsguideownerblock') {
    // Block access to the block on node edit pages.
    return \Drupal\Core\Access\AccessResult::forbidden();
  }

  // Allow access to the block for other routes.
  return \Drupal\Core\Access\AccessResult::allowed();
}

/**
 * Implements hook_preprocess_page().
 */
function lgmsmodule_preprocess_page(&$variables) {
  // Check if the current page is a guide node
  if ($node = \Drupal::routeMatch()->getParameter('node')) {

    if ($node->getType() == 'guide') {
      $variables['#attached']['library'][] = 'lgmsmodule/lgmsmodule';
    }
  }
}

/**
 * Creates a taxonomy vocabulary if it doesn't already exist.
 *
 * @param string $vid The machine name of the vocabulary.
 * @param string $name The human-readable name of the vocabulary.
 * @param string $description The description of the vocabulary.
 * @return void
 * @throws EntityStorageException
 */
function create_vocab(string $vid, string $name, string $description): void {
  $vocabulary = Vocabulary::create([
    'vid' => $vid,
    'name' => $name,
    'description' => $description,
  ]);
  $vocabulary->save();
}


/**
 * Adds terms to a taxonomy vocabulary if they don't already exist.
 *
 * @param array $terms The terms to add.
 * @param string $vid The machine name of the vocabulary.
 * @return void
 * @throws EntityStorageException
 */
function add_terms(array $terms, string $vid): void {
  foreach ($terms as $term_name) {
    $new_term = Term::create([
      'vid' => $vid,
      'name' => $term_name,
    ]);
    $new_term->enforceIsNew();
    $new_term->save();
  }
}


/**
 * Helper function to create content types.
 * @throws EntityStorageException
 */
function createContentType($id, $name): void
{
  $type = NodeType::load($id);
  if (!$type) {
    $type = NodeType::create([
      'type' => $id,
      'name' => $name,
    ]);
    $type->save();
  }
}

/**
 * Helper function to create fields.
 * @throws EntityStorageException
 */
function createField($field_id, $entity_type, $bundle, $field_name, $field_type, $storage_settings, $field_settings, $widget_type, $widget_settings, $status, $cardinal, $field_weight): void
{
  // Create field storage.
  $storage = FieldStorageConfig::loadByName($entity_type, $field_id);
  if (!$storage) {
    $storage = FieldStorageConfig::create([
      'field_name' => $field_id,
      'entity_type' => $entity_type,
      'type' => $field_type,
      'settings' => $storage_settings ?? [],
    ]);

    if ($cardinal){
      $storage->setCardinality(FieldStorageDefinitionInterface::CARDINALITY_UNLIMITED);
    }

    $storage->save();
  }

  // Create field.
  $field = FieldConfig::loadByName($entity_type, $bundle, $field_id);
  if (!$field) {
    $field = FieldConfig::create([
      'field_storage' => $storage,
      'bundle' => $bundle,
      'label' => $field_name,
      'settings' => $field_settings ?? [],
    ]);
    $field->save();

    // Configure form display.
    $form_display = EntityFormDisplay::load($entity_type . '.' . $bundle . '.default');
    if (!$form_display) {
      $form_display = EntityFormDisplay::create([
        'targetEntityType' => $entity_type,
        'bundle' => $bundle,
        'mode' => 'default',
        'status' => TRUE,
      ]);
    }
    $form_display->setComponent($field_id, [
      'type' => $widget_type,
      'settings' => $widget_settings,
      'weight'=> $field_weight,
    ])->save();

    // Configure view display.
    $view_display = EntityViewDisplay::load($entity_type . '.' . $bundle . '.default');
    if (!$view_display) {
      $view_display = EntityViewDisplay::create([
        'targetEntityType' => $entity_type,
        'bundle' => $bundle,
        'mode' => 'default',
        'status' => TRUE,
      ]);
    }

    // Remove the field from the view display.
    if ($view_display->getComponent($field_id)) {
      $view_display->removeComponent($field_id);
      $view_display->save();
    }
  }
}

/**
 * This is executed when a node is created
 * Implements hook_node_insert().
 */
function lgmsmodule_node_insert(NodeInterface $node): void
{
  lgmsmodule_refresh_cache($node);
  lgmsmodule_generate_url_alias($node);
}

/**
 * This is executed when a node is updated
 * Implements hook_node_update().
 */
function lgmsmodule_node_update(NodeInterface $node): void
{
  lgmsmodule_refresh_cache($node);
}

/**
 * Helper function to refresh cache.
 */
function lgmsmodule_refresh_cache(NodeInterface $node): void
{
  if ($node->bundle() === 'guide_box') {
    // Get the 'parent_page' ID from the 'guide_box'
    $parent_page_id = $node->get('field_parent_node')->target_id;

    // Clear the cache of the page
    if ($parent_page_id) {
      $custom_cache_tag = 'lgmsmodule_node_view:' . $parent_page_id;
      \Drupal::service('cache_tags.invalidator')->invalidateTags([$custom_cache_tag]);
    }

    // Clear the cache of the guide
    $parent_page = Node::load($parent_page_id);
    lgmsmodule_refresh_cache($parent_page);
  } elseif ($node->bundle() === 'guide_page') {
    // Invalidate cache for 'guide_page' as before
    $parent_guide_id = $node->get('field_parent_guide')->target_id;

    if ($parent_guide_id) {
      $custom_cache_tag = 'lgmsmodule_node_view:' . $parent_guide_id;
      \Drupal::service('cache_tags.invalidator')->invalidateTags([$custom_cache_tag]);
    }
  }
}

function build_item(EntityInterface $entity, EntityInterface $box, EntityInterface $item): array
{
  $item_container = [
    '#type' => 'container',
    '#attributes' => ['class' => ['guide-item']],
  ];

  $route = '';
  if ($item->hasField('field_html_item') && !$item->get('field_html_item')->isEmpty()) {
    $html = $item->get('field_html_item')->entity;

    $item_container['content'] = [
      '#type' => 'processed_text',
      '#text' => $html->get('field_text_box_item2')->value,
      '#format' => $html->get('field_text_box_item2')->format,
    ];

    $route = 'add_html.form';
  }

  if($item->access('update')) {
    $url = Url::fromRoute($route, [], ['query' => [
      'current_node' => $entity->id(),
      'current_box' => $box->id(),
      'current_item' => $item->id()]
    ]);

    $edit_link = [
      '#type' => 'link',
      '#title' => [
        '#type' => 'html_tag',
        '#tag' => 'i',
        '#attributes' => [
          'class' => ['fa', 'fa-edit', 'edit-icon'],
        ],
      ],
      '#url' => $url,
      '#attributes' => [
        'class' => ['use-ajax'],
        'data-dialog-type' => 'modal',
        'data-dialog-options' => Json::encode(['width' => 800]),
        'title' => 'Edit Box',
        'style' => 'text-decoration: none;',
      ],
    ];
    $item_container['edit_link'] = $edit_link;
  }

  return$item_container;
}

/**
 * Implements hook_ENTITY_TYPE_view() for node entities.
 */
function lgmsmodule_node_view(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display, $view_mode): void {
  if (($entity->bundle() === 'guide' || $entity->bundle() === 'guide_page') && $view_mode === 'full') {
    $build['#attached']['library'][] = 'lgmsmodule/lgmsmodule';
    $build['#attached']['library'][] = 'core/drupal.dialog.ajax';

    // Add a custom cache tag to the build array
    $custom_cache_tag = 'lgmsmodule_node_view:' . $entity->id();
    $build['#cache']['tags'][] = $custom_cache_tag;

    $title = $entity->label();
    $description = $entity->get("field_description")->value;

    if($entity->get('field_hide_description')->value){
      $description = '';
    }

    // Concatenate the title, a horizontal divider, and the description.
    // The <hr> tag is used as the divider between the title and description.
    $build['header'] = [
      '#markup' => "<h2><strong>$title</strong></h2><hr><p>{$description}</p>",
    ];

    $build['boxes']['#attached']['library'][] = 'lgmsmodule/fontawesome';

    $boxes = $entity->get('field_child_boxes')->referencedEntities();

    foreach ($boxes as $box) {
      $unpublished_class = '';
      if(!$box->isPublished()){
        if(!\Drupal::currentUser()->isAuthenticated()){
          continue;
        }
        $unpublished_class = 'node--unpublished';
      }

      $items = $box->get('field_box_items')->referencedEntities();

      $guide_box_build['items'] = [
        '#type' => 'container',
        '#attributes' => ['class' => ['guide-box-items-container']],
      ];

      foreach ($items as $item) {
        // Add the item container to the guide box items.
        $guide_box_build['items'][] = build_item($entity, $box, $item);
      }


      if($box->access('update')) {
        $guide_box_build['items_list'] = [
          '#type' => 'container',
          '#attributes' => ['id' => 'add-reorder-list', 'class' => ['guide-item2']],
          'children' => [
            'html_item' => [
              '#type' => 'html_tag',
              '#tag' => 'li',
              'content' => [
                '#type' => 'link',
                '#title' => ('HTML'),
                '#url' => Url::fromRoute('add_html.form', [], ['query' => ['current_box' => $box->id(), 'current_node' => $entity->id()]]),
                '#attributes' => [
                  'class' => ['use-ajax'],
                  'data-dialog-type' => 'modal',
                  'data-dialog-options' => Json::encode(['width' => 800]),
                  'title' => 'Re-position Box',
                  'style' => 'text-decoration: none;',
                ],
              ],
            ],
            're-order' => [
              '#type' => 'html_tag',
              '#tag' => 'li',
              'content' => [
                '#type' => 'link',
                '#title' => t('Re-Order'),
                '#url' => Url::fromRoute('re_order_box_item.form', [], ['query' => ['current_box' => $box->id(), 'current_node' => $entity->id()]]),
                '#attributes' => [
                  'class' => ['use-ajax'],
                  'data-dialog-type' => 'modal',
                  'data-dialog-options' => Json::encode(['width' => 800]),
                  'title' => 'Re-position Box',
                  'style' => 'text-decoration: none;',
                ],
              ],
            ],
          ],
        ];
      }

      $build['boxes'][] = [
        '#type' => 'container',
        '#attributes' => ['class' => ['guide-box-container ' . $unpublished_class]],
        'title_wrapper' => [
          '#type' => 'html_tag',
          '#tag' => 'div',
          '#attributes' => [
            'class' => ['title-edit-wrapper ' . $unpublished_class],
          ],
          'title' => [
            '#type' => 'html_tag',
            '#tag' => 'h3',
            '#value' => $box->label(),
            '#attributes' => ['class' => ['guide-box-title']],
          ],
          'icons' => $box->access('update') ?[
            '#type' => 'html_tag',
            '#tag' => 'div',
            '#attributes' => [
              'class' => ['icons-container'],
            ],
            're_order_icon' => [
              '#type' => 'link',
              '#title' => [
                '#type' => 'html_tag',
                '#tag' => 'i',
                '#attributes' => [
                  'class' => ['fa', 'fa-bars', 're-order-icon'],
                ],
              ],
              '#url' => Url::fromRoute('re_order_guide_box.form', [], ['query' => ['current_node' => $entity->id()]]),
              '#attributes' => [
                'class' => ['use-ajax'],
                'data-dialog-type' => 'modal',
                'data-dialog-options' => Json::encode(['width' => 800]),
                'title' => 'Re-position Box',
                'style' => 'text-decoration: none;',
              ],
            ],
            'edit_icon' => [
              '#type' => 'link',
              '#title' => [
                '#type' => 'html_tag',
                '#tag' => 'i',
                '#attributes' => [
                  'class' => ['fa', 'fa-edit', 'edit-icon'],
                ],
              ],
              '#url' => Url::fromRoute('edit_guide_box.form', [], ['query' => ['current_node' => $entity->id(), 'current_box' =>$box->id()]]),
              '#attributes' => [
                'class' => ['use-ajax'],
                'data-dialog-type' => 'modal',
                'data-dialog-options' => Json::encode(['width' => 800]),
                'title' => 'Edit Box',
                'style' => 'text-decoration: none;',
              ],
            ],
            'close_icon' => [
              '#type' => 'link',
              '#title' => [
                '#type' => 'html_tag',
                '#tag' => 'i',
                '#attributes' => [
                  'class' => ['fa', 'fa-times', 'close-icon'],
                ],
              ],
              '#url' => Url::fromRoute('delete_guide_box.form', [], ['query' => ['current_node' => $entity->id(), 'current_box' =>$box->id()]]),
              '#attributes' => [
                'class' => ['use-ajax'],
                'data-dialog-type' => 'modal',
                'data-dialog-options' => Json::encode(['width' => 800]),
                'title' => 'Delete Box',
                'style' => 'text-decoration: none;',
              ],
            ],
          ] : [],
        ],
        'body' => $guide_box_build,
      ];

    }
    if(\Drupal::currentUser()->isAuthenticated()) {
      $build['add_guide_page_box_link'] = [
        '#type' => 'container',
        'link' => createBoxButton($entity),
      ];
      $build['reuse_guide_page_box_link'] = reuseGuideBoxButton($entity);
    }

    $last_changed_timestamp = $entity->getChangedTime();

    $last_changed_formatted = \Drupal::service('date.formatter')->format($last_changed_timestamp, 'medium');

    $build['last_changed'] = [
      '#markup' => "<p>Last updated: {$last_changed_formatted}</p>",
    ];

  }
}

function reuseGuideBoxButton($node): array
{
  $url = Url::fromRoute('reuse_guide_box.form', [], ['query' => ['current_node' => $node->id()]]);
  $link = Link::fromTextAndUrl(t('Import Guide Box'), $url)->toRenderable();
  $link['#attributes'] = [
    'class' => ['use-ajax'],
    'data-dialog-type' => 'modal',
    'data-dialog-options' => Json::encode(['width' => 800]),
  ];

  return $link;
}

function createBoxButton($node): array
{
  $url = Url::fromRoute('create_guide_box.form', [], ['query' => ['current_node' => $node->id()]]);
  $link = Link::fromTextAndUrl(t('Create Guide Box'), $url)->toRenderable();
  $link['#attributes'] = [
    'class' => ['use-ajax'],
    'data-dialog-type' => 'modal',
    'data-dialog-options' => Json::encode(['width' => 800]),
  ];

  return $link;
}


/**
 * Implements hook_install().
 * @throws EntityStorageException
 */
function lgmsModule_install(): void
{

  // Get the default theme.
  $default_theme = \Drupal::config('system.theme')->get('default');

  $block_id = 'lgmsguideownerblock';

  if (!\Drupal\block\Entity\Block::load($block_id)) {
    $block = \Drupal\block\Entity\Block::create([
      'id' => $block_id,
      'theme' => $default_theme,
      'region' => 'sidebar_first',
      'weight' => 0,
      'provider' => 'lgmsmodule',
      'plugin' => 'lgms_guide_owner_block',
      'label' => 'LGMS Guide Owner Block',
      'label_display' => 'visible',
      'visibility' => [
        'entity_bundle:node' => [
          'id' => 'entity_bundle:node',
          'bundles' => [
            'guide' => 'guide',
            'guide_page' => 'guide_page',
            'sub_page' => 'sub_page'
          ],
          'negate' => FALSE,
          'context_mapping' => [
            'node' => '@node.node_route_context:node',
          ],
        ],
      ],
    ]);

    $block->save();

    // After the block->save() call.
    \Drupal::service('cache_tags.invalidator')->invalidateTags(['block_list']);
    \Drupal::service('router.builder')->rebuild();

    \Drupal::messenger()->addMessage('LGMS Guide Owner Block placed successfully.');
  } else {
    \Drupal::messenger()->addMessage('The LGMS Guide Owner Block already exists.');
  }

  $block_id = 'pageviewblock';
  if (!\Drupal\block\Entity\Block::load($block_id)) {
    $block = \Drupal\block\Entity\Block::create([
      'id' => $block_id,
      'theme' => $default_theme,
      'region' => 'sidebar_first',
      'weight' => 1,
      'provider' => 'lgmsmodule',
      'plugin' => 'page_view_block',
      'label' => 'LGMS page view Block',
      'label_display' => 'visible',
      'visibility' => [
        'entity_bundle:node' => [
          'id' => 'entity_bundle:node',
          'bundles' => [
            'guide' => 'guide',
            'guide_page'=>'guide_page',
            'sub_page'=>'sub_page'
          ],
          'negate' => FALSE,
          'context_mapping' => [
            'node' => '@node.node_route_context:node',
          ],
        ],
      ],
    ]);

    $block->save();
    \Drupal::messenger()->addMessage('LGMS Page View Block placed successfully.');
  } else {
    \Drupal::messenger()->addMessage('The LGMS Page View Block already exists.');
  }

  // Create content types.
  createContentType('guide_page', 'Guide Page');
  createContentType('guide_box', 'Guide Box');
  createContentType('sub_page', 'Sub Page');
  createContentType('guide_item', 'Guide Box Item');
  createContentType('guide_html_item', 'HTML Box Item');

  // Create a new Guide Type taxonomy.
  create_vocab('LGMS_Guide_Type', 'Guide Type', 'Use Guide Type to group guides by their type');

  // Add terms to the Guide Type taxonomy
  $terms = array(
    'General purpose Guide',
    'Subject Guide',
    'Topic Guide',
    'Course Guide',
  );
  add_terms($terms, 'LGMS_Guide_Type');

  // Create a new Guide Subject taxonomy.
  create_vocab('LGMS_Guide_Subject', 'Guide Subject', 'Use Guide Subject to group guides related to each other under the same category');

  // Add terms to the Guide Subject taxonomy
  $terms = array(
    'Anthropology',
    'Biology ',
    'Biotechnology',
    'Business & Management',
    'Chemistry',
    'Communication & Mass Media',
    'Computer Science',
    'Drama & Theater Arts',
    'Earth & Atmospheric Sciences',
    'Economics',
    'Education',
    'Engineering',
    'Environmental Sciences',
    'Ethnic & Cultural Studies',
    'Geography & Cartography',
    'Health & Medicine',
    'History',
    'Language & Linguistics',
    'Law',
    'Library & Information Science',
    'Literature & Writing',
    'Marketing',
    'Mathematics',
    'Music',
    'Nursing & Allied Health',
    'Nutrition & Dietetics',
    'Physics',
    'Political Science',
    'Politics & Government',
    'Psychology',
    'Religion & Philosophy',
    'Science',
    'Sociology',
    'Sports & Leisure',
    'Sports Medicine',
    'Veterinary Medicine',
    'Visual Arts',
    'Women\'s Studies & Feminism',
  );
  add_terms($terms, 'LGMS_Guide_Subject');

  // Create a new Guide Group taxonomy.
  create_vocab('LGMS_Guide_Group', 'Guide Group', 'Use Guide Group to assign a guide to a specific group and.');

  // Add terms to the Guide Group taxonomy
  $terms = array(
    'Group 1',
    'Group 2',
    'Group 3',
    'Group 4',
  );
  add_terms($terms, 'LGMS_Guide_Group');

  // Create field storages and instances...
  createField(
    'field_lgms_guide_subject',
    'node',
    'guide',
    'Subject',
    'entity_reference',
    ['target_type' => 'taxonomy_term',],
    ['handler' => 'default:taxonomy_term',
      'handler_settings' => [
        'target_bundles' => [
          'LGMS_Guide_Subject' => 'LGMS_Guide_Subject',
        ],
      ],
    ],
    'options_buttons',
    [],
    False,
    True,
    3
  );

  createField(
    'field_lgms_guide_type',
    'node',
    'guide',
    'Type',
    'entity_reference',
    ['target_type' => 'taxonomy_term',],
    ['handler' => 'default:taxonomy_term',
      'handler_settings' => [
        'target_bundles' => [
          'LGMS_Guide_Subject' => 'LGMS_Guide_Type',
        ],
      ],
    ],
    'options_select',
    ['weight' => 1],
    False,
    False,
    4
  );

  createField(
    'field_lgms_guide_group',
    'node',
    'guide',
    'Group',
    'entity_reference',
    ['target_type' => 'taxonomy_term',],
    ['handler' => 'default:taxonomy_term',
      'handler_settings' => [
        'target_bundles' => [
          'LGMS_Guide_Subject' => 'LGMS_Guide_Group',
        ],
      ],
    ],
    'options_select',
    ['weight' => 2],
    False,
    False,
    5
  );

  // Guide Description field
  createField(
    'field_description',
    'node',
    'guide',
    'Description',
    'text_long',
    [],
    [],
    'text_textarea',
    [],
    False,
    False,
    2
  );

  // Add a reference field to Guide content type on Guide Page.
  createField(
    'field_parent_guide',
    'node',
    'guide_page',
    'Parent Guide',
    'entity_reference',
    ['target_type' => 'node',],
    ['handler' => 'default:node',
      'handler_settings' => [
        'target_bundles' => [
          'guide' => 'guide',
        ],
      ],
    ],
    'entity_reference_autocomplete',
    [],
    TRUE,
    False,
    1
  );


  createField(
    'field_parent_node',
    'node',
    'guide_box',
    'Parent node',
    'entity_reference',
    ['target_type' => 'node',],
    ['handler' => 'default:node',
      'handler_settings' => [
        'target_bundles' => [
          'guide' => 'guide',
          'guide_page' => 'guide_page',
        ],
      ],
    ],
    'entity_reference_autocomplete',
    [],
    TRUE,
    False,
    1,
  );

  createField(
    'field_parent_page',
    'node',
    'sub_page',
    'Parent Page',
    'entity_reference',
    ['target_type' => 'node',],
    ['handler' => 'default:node',
      'handler_settings' => [
        'target_bundles' => [
          'guide_page' => 'guide_page',
        ],
      ],
    ],
    'entity_reference_autocomplete',
    [],
    TRUE,
    False,
    1
  );

  //add page description field
  createField(
    'field_description',
    'node',
    'guide_page',
    'Description',
    'text_long',
    [],
    [],
    'text_textarea',
    ['rows' => 5, 'placeholder' => 'Enter the page description here...'],
    TRUE,
    False,
    2
  );

  createField(
    'field_draft_mode',
    'node',
    'guide_page',
    'Draft Mode',
    'boolean',
    [],
    [],
    'boolean_checkbox',
    [ // Widget settings.
      'settings' => [
        'display_label' => TRUE,
      ],
    ],
    FALSE,
    FALSE,
    10,
  );
  createField(
    'field_draft_mode',
    'node',
    'sub_page',
    'Draft Mode',
    'boolean',
    [],
    [],
    'boolean_checkbox',
    [ // Widget settings.
      'settings' => [
        'display_label' => TRUE,
      ],
    ],
    FALSE,
    FALSE,
    5
  );

  createField(
    'field_description',
    'node',
    'sub_page',
    'Description',
    'text_long',
    [],
    [],
    'text_textarea',
    ['rows' => 5, 'placeholder' => 'Enter the page description here...'],
    TRUE,
    False,
    3
  );

  // page box children
  createField(
    'field_child_boxes',
    'node',
    'guide_page',
    'Children Boxes',
    'entity_reference',
    ['target_type' => 'node',],
    ['handler' => 'default:node',
      'handler_settings' => [
        'target_bundles' => [
          'guide_box' => 'guide_box',
        ],
      ],
      'sort' => [
        'field' => '_none',
      ],
    ],
    'entity_reference_autocomplete',
    [],
    TRUE,
    TRUE,
    5
  );

  createField(
    'field_text_box_item2',
    'node',
    'guide_html_item',
    'Text',
    'text_long',
    [],
    [],
    'text_textarea',
    ['rows' => 20,],
    TRUE,
    False,
    1
  );

  createField(
    'field_html_item',
    'node',
    'guide_item',
    'html item',
    'entity_reference',
    ['target_type' => 'node',],
    ['handler' => 'default:node',
      'handler_settings' => [
        'target_bundles' => [
          'guide_html_item' => 'guide_html_item',
        ],
      ],
      'sort' => [
        'field' => '_none',
      ],
    ],
    'entity_reference_autocomplete',
    [],
    TRUE,
    True,
    4
  );


  //guide_item
  createField(
    'field_box_items',
    'node',
    'guide_box',
    'Items List',
    'entity_reference',
    ['target_type' => 'node',],
    ['handler' => 'default:node',
      'handler_settings' => [
        'target_bundles' => [
          'guide_item' => 'guide_item',
        ],
      ],
      'sort' => [
        'field' => '_none',
      ],
    ],
    'entity_reference_autocomplete',
    [],
    TRUE,
    True,
    4
  );

  // Guide box children
  createField(
    'field_child_boxes',
    'node',
    'guide',
    'Children Boxes',
    'entity_reference',
    ['target_type' => 'node',],
    ['handler' => 'default:node',
      'handler_settings' => [
        'target_bundles' => [
          'guide_box' => 'guide_box',
        ],
      ],
      'sort' => [
        'field' => '_none',
      ],
    ],
    'entity_reference_autocomplete',
    [],
    TRUE,
    TRUE,
    5
  );

  createField(
    'field_hide_description',
    'node',
    'guide',
    'Hide Description',
    'boolean',
    [],
    [
      'default_value' => 0,
      'on_label' => 'Yes',
      'off_label' => 'No',
    ],
    'boolean_checkbox',
    [],
    TRUE,
    1,
    1
  );

  createField(
    'field_hide_description',
    'node',
    'guide_page',
    'Hide Description',
    'boolean',
    [],
    [
      'default_value' => 0,
      'on_label' => 'Yes',
      'off_label' => 'No',
    ],
    'boolean_checkbox',
    [],
    TRUE,
    1,
    1
  );

  // Disable the display of author and date information for guide, guide_page and guide_box.
  disable_field('guide', 'display_submitted');
  disable_field('guide_page', 'display_submitted');
  disable_field('guide_box', 'display_submitted');
  disable_field('sub_page', 'display_submitted');
}

/**
 * @throws EntityStorageException
 */
function disable_field($id, $field): void
{
  // Load the content type
  $content_type = NodeType::load($id);
  if ($content_type) {
    // Disable the field
    $content_type->set($field, FALSE);
    $content_type->save();
  }
}


/**
 * Implements hook_uninstall().
 * @throws EntityStorageException
 */
function lgmsModule_uninstall(): void
{
  // Delete the Guide Type taxonomy vocabulary and its terms.
  delete_taxonomies('LGMS_Guide_Type');

  // Delete the Guide Subject taxonomy vocabulary and its terms.
  delete_taxonomies('LGMS_Guide_Subject');

  // Delete the Guide Group taxonomy vocabulary and its terms.
  delete_taxonomies('LGMS_Guide_Group');

  // Delete field storages.
  delete_field_storage('field_lgms_guide_subject');
  delete_field_storage('field_lgms_guide_type');
  delete_field_storage('field_lgms_guide_group');
  delete_field_storage('field_lgms_guide_subject');
  delete_field_storage('field_lgms_guide_type');
  delete_field_storage('field_lgms_guide_group');
  delete_field_storage('field_guide_description');
  delete_field_storage('field_parent_guide');
  delete_field_storage('field_parent_node');
  delete_field_storage('field_description');
  delete_field_storage('field_text_box_item');

  $content_type = NodeType::load('guide_page');
  $content_type?->delete();

  $content_type = NodeType::load('guide_box');
  $content_type?->delete();
}

/**
 * Deletes a Taxonomy and its terms.
 * @throws EntityStorageException
 */
function delete_taxonomies($vocab_machine_name): void
{
  $vocabulary = Vocabulary::load($vocab_machine_name);
  if ($vocabulary) {
    try {
      $terms = \Drupal::entityTypeManager()
        ->getStorage('taxonomy_term')
        ->loadByProperties(['vid' => $vocab_machine_name]);

      foreach ($terms as $term) {
        $term->delete();
      }
    } catch (InvalidPluginDefinitionException|PluginNotFoundException $e) {
    }
    $vocabulary->delete();
  }
}

/**
 * Deletes storage Fields
 * @throws EntityStorageException
 */
function delete_field_storage($field_storage_name): void
{
  $field_storage = FieldStorageConfig::load($field_storage_name);
  $field_storage?->delete();
}
